<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>여행 플래너</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK (Version 11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, onSnapshot, deleteDoc, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.Firebase = {
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken,
            getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, onSnapshot, deleteDoc, query, writeBatch
        };
    </script>
    
    <!-- React & Icons Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Plus, Edit2, Trash2, MapPin, Clock, Check, X, Settings, Search, Calendar, ChevronRight, StickyNote, AlertTriangle, LogOut, Loader2, ArrowLeft, Plane } from 'lucide-react';

        // --- Styles ---
        const FontStyles = () => (
          <style>{`
            /* 기본 폰트들 */
            @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css");
            @import url("https://cdn.jsdelivr.net/gh/sun-typeface/suit/fonts/static/woff2/SUIT.css");
            
            /* 나눔스퀘어 */
            @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquare@2.0/nanumsquare.css");

            /* 서울한강체 */
            @font-face {
                font-family: 'SeoulHangangM';
                src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_two@1.0/SeoulHangangM.woff') format('woff');
                font-weight: normal;
                font-style: normal;
            }

            /* 어비 마이센체 (URL 수정됨) */
            @font-face {
                font-family: 'UhBeeMysen';
                src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_five@2.0/UhBeeMysen.woff') format('woff');
                font-weight: normal;
                font-style: normal;
            }

            /* 기본 바디 폰트를 프리텐다드로 설정하여 리스트 화면 적용 보장 */
            body { 
                background-color: #f2f4f6; 
                font-family: 'Pretendard', sans-serif;
            }
            
            .font-pretendard { font-family: 'Pretendard', sans-serif; }
            .font-suit { font-family: 'SUIT', sans-serif; }
            .font-nanum { font-family: 'NanumSquare', sans-serif; }
            .font-seoul { font-family: 'SeoulHangangM', sans-serif; }
            .font-mysen { font-family: 'UhBeeMysen', sans-serif; }

            .no-scrollbar::-webkit-scrollbar { display: none; }
            .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
            .glass-effect { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
          `}</style>
        );

        const themeConfig = {
          blue: { name: '오션 블루', primary: 'bg-blue-500', hover: 'hover:bg-blue-600', light: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-100', ring: 'focus:ring-blue-500', shadow: 'shadow-blue-200' },
          emerald: { name: '제주 그린', primary: 'bg-emerald-500', hover: 'hover:bg-emerald-600', light: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-100', ring: 'focus:ring-emerald-500', shadow: 'shadow-emerald-200' },
          rose: { name: '선셋 핑크', primary: 'bg-rose-500', hover: 'hover:bg-rose-600', light: 'bg-rose-50', text: 'text-rose-600', border: 'border-rose-100', ring: 'focus:ring-rose-500', shadow: 'shadow-rose-200' },
          violet: { name: '미드나잇 퍼플', primary: 'bg-violet-500', hover: 'hover:bg-violet-600', light: 'bg-violet-50', text: 'text-violet-600', border: 'border-violet-100', ring: 'focus:ring-violet-500', shadow: 'shadow-violet-200' },
          orange: { name: '감귤 오렌지', primary: 'bg-orange-500', hover: 'hover:bg-orange-600', light: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-100', ring: 'focus:ring-orange-500', shadow: 'shadow-orange-200' },
        };

        const useFirebase = () => {
            const [services, setServices] = useState(null);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const init = async () => {
                    let config;
                    try { config = window.__firebase_config ? JSON.parse(window.__firebase_config) : null; } catch (e) {}

                    if (!config) {
                        config = {
                            apiKey: "AIzaSyDRRKbU60lAQn7KwJSoyn7kCupEBR4tiI4",
                            authDomain: "planner-f967b.firebaseapp.com",
                            projectId: "planner-f967b",
                            storageBucket: "planner-f967b.firebasestorage.app",
                            messagingSenderId: "399882909960",
                            appId: "1:399882909960:web:9b9b23c63d9d7ad131d4bd",
                            measurementId: "G-2Z9PC2VD6W"
                        };
                    }

                    const { initializeApp, getAuth, onAuthStateChanged, getFirestore, signInWithCustomToken } = window.Firebase;
                    
                    try {
                        const app = initializeApp(config);
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'my-travel-planner';

                        setServices({ auth, db, appId });

                        if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                             try { await signInWithCustomToken(auth, window.__initial_auth_token); } catch(e) {}
                        }

                        const unsubscribe = onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            setLoading(false);
                        });
                        return () => unsubscribe();
                    } catch (error) {
                        console.error(error);
                        setLoading(false);
                    }
                };
                
                const timer = setInterval(() => { if (window.Firebase) { clearInterval(timer); init(); } }, 100);
            }, []);
            return { services, user, loading };
        };

        // --- Common Components ---
        const InputField = ({ label, value, onChange, type = "text", placeholder, theme = 'blue' }) => (
          <div className="mb-4 w-full">
            <label className="block text-sm font-medium text-gray-500 mb-1 ml-1">{label}</label>
            <input type={type} value={value} onChange={onChange} placeholder={placeholder}
              className={`w-full bg-gray-50 border border-gray-100 rounded-2xl px-4 py-3 text-gray-900 focus:outline-none focus:ring-2 ${themeConfig[theme].ring}/50 focus:border-transparent transition-all`} />
          </div>
        );
        const TextAreaField = ({ label, value, onChange, placeholder, theme = 'blue' }) => (
          <div className="mb-4 w-full">
            <label className="block text-sm font-medium text-gray-500 mb-1 ml-1">{label}</label>
            <textarea value={value} onChange={onChange} placeholder={placeholder} rows={3}
              className={`w-full bg-gray-50 border border-gray-100 rounded-2xl px-4 py-3 text-gray-900 focus:outline-none focus:ring-2 ${themeConfig[theme].ring}/50 focus:border-transparent transition-all resize-none`} />
          </div>
        );
        const Modal = ({ isOpen, onClose, title, children }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-black/30 backdrop-blur-sm transition-opacity" onClick={onClose} />
              <div className="relative bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 transform transition-all scale-100 max-h-[90vh] overflow-y-auto no-scrollbar">
                <div className="flex justify-between items-center mb-6 sticky top-0 bg-white z-10 py-2">
                  <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                  <button onClick={onClose} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors"><X size={20} className="text-gray-600" /></button>
                </div>
                {children}
              </div>
            </div>
          );
        };

        // --- Main Logic & Sub-Apps ---

        // [Trip List Component]
        const TripList = ({ services, user, onSelectTrip, onLogout }) => {
            const [trips, setTrips] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
            const [newTripData, setNewTripData] = useState({ title: '', startDate: '', endDate: '', theme: 'blue' });

            useEffect(() => {
                const { db, appId } = services;
                const { collection, onSnapshot, doc, getDoc, setDoc, getDocs, writeBatch } = window.Firebase;

                // *** Migration Logic: Check if we need to migrate old data ***
                const checkAndMigrate = async () => {
                    const tripsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'trips');
                    const tripsSnap = await getDocs(tripsRef);

                    if (tripsSnap.empty) {
                        // Check for old data
                        const oldSettingsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config');
                        const oldSettingsSnap = await getDoc(oldSettingsRef);

                        if (oldSettingsSnap.exists()) {
                            const oldData = oldSettingsSnap.data();
                            // Create new trip doc from old settings
                            const newTripRef = doc(tripsRef); // Auto ID
                            await setDoc(newTripRef, {
                                title: oldData.tripInfo?.title || '나의 여행',
                                startDate: oldData.tripInfo?.startDate || new Date().toISOString().split('T')[0],
                                endDate: oldData.tripInfo?.endDate || new Date().toISOString().split('T')[0],
                                theme: oldData.theme || 'blue',
                                font: oldData.font || 'pretendard',
                                createdAt: new Date().toISOString()
                            });

                            // Move items
                            const oldItemsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'items');
                            const oldItemsSnap = await getDocs(oldItemsRef);
                            
                            const batch = writeBatch(db);
                            oldItemsSnap.forEach(itemDoc => {
                                const newItemRef = doc(db, 'artifacts', appId, 'users', user.uid, 'trips', newTripRef.id, 'items', itemDoc.id);
                                batch.set(newItemRef, itemDoc.data());
                            });
                            
                            if (!oldItemsSnap.empty) await batch.commit();
                        }
                    }
                };
                
                checkAndMigrate().then(() => {
                     const unsub = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'trips'), (snap) => {
                        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        // Sort by created date or start date
                        list.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
                        setTrips(list);
                        setLoading(false);
                    });
                    return () => unsub();
                });

            }, [services, user]);

            const handleCreate = async () => {
                if(!newTripData.title) return alert("여행 제목을 입력해주세요.");
                const { db, appId } = services;
                const { collection, addDoc } = window.Firebase;
                
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'trips'), {
                    ...newTripData,
                    font: 'pretendard',
                    createdAt: new Date().toISOString()
                });
                setIsCreateModalOpen(false);
                setNewTripData({ title: '', startDate: '', endDate: '', theme: 'blue' });
            };

            const handleDeleteTrip = async (e, tripId) => {
                e.stopPropagation();
                if(!confirm("이 여행 계획을 정말 삭제할까요?\n안의 모든 일정이 함께 삭제됩니다.")) return;
                 const { db, appId } = services;
                 const { doc, deleteDoc } = window.Firebase;
                 await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'trips', tripId));
            };

            if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-blue-500" /></div>;

            return (
                <div className="min-h-screen bg-gray-50 p-6 font-pretendard">
                    <div className="max-w-md mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-2xl font-bold text-gray-900">나의 여행 리스트</h1>
                            <button onClick={onLogout} className="p-2 text-gray-400 hover:text-gray-600"><LogOut size={20}/></button>
                        </div>

                        <div className="grid gap-4">
                            {trips.map(trip => (
                                <div key={trip.id} onClick={() => onSelectTrip(trip.id)} 
                                     className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 cursor-pointer hover:shadow-md transition-all active:scale-[0.98] relative group">
                                    <div className={`w-12 h-12 rounded-2xl ${themeConfig[trip.theme || 'blue'].light} flex items-center justify-center mb-4 text-2xl`}>
                                        ✈️
                                    </div>
                                    <h3 className="text-lg font-bold text-gray-900 mb-1">{trip.title}</h3>
                                    <p className="text-sm text-gray-500">{trip.startDate} - {trip.endDate}</p>
                                    <button onClick={(e) => handleDeleteTrip(e, trip.id)} className="absolute top-4 right-4 p-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                                        <Trash2 size={18} />
                                    </button>
                                </div>
                            ))}
                            
                            <button onClick={() => setIsCreateModalOpen(true)} className="border-2 border-dashed border-gray-300 rounded-3xl p-6 flex flex-col items-center justify-center text-gray-400 hover:border-blue-400 hover:text-blue-500 transition-colors min-h-[160px]">
                                <Plus size={32} className="mb-2"/>
                                <span className="font-bold">새로운 여행 추가</span>
                            </button>
                        </div>

                        <Modal isOpen={isCreateModalOpen} onClose={() => setIsCreateModalOpen(false)} title="새로운 여행 만들기">
                            <div className="space-y-1">
                                <InputField label="어디로 떠나시나요?" placeholder="예: 오사카 먹방 여행" value={newTripData.title} onChange={e => setNewTripData({...newTripData, title: e.target.value})} />
                                <div className="grid grid-cols-2 gap-3">
                                    <InputField label="시작일" type="date" value={newTripData.startDate} onChange={e => setNewTripData({...newTripData, startDate: e.target.value})} />
                                    <InputField label="종료일" type="date" value={newTripData.endDate} onChange={e => setNewTripData({...newTripData, endDate: e.target.value})} />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-500 mb-2 ml-1">테마 컬러</label>
                                    <div className="flex gap-2">
                                        {Object.entries(themeConfig).map(([key, conf]) => (
                                            <button key={key} onClick={() => setNewTripData({...newTripData, theme: key})}
                                                className={`w-8 h-8 rounded-full ${conf.primary} ring-2 ring-offset-2 transition-all ${newTripData.theme === key ? 'ring-gray-300 scale-110' : 'ring-transparent'}`} />
                                        ))}
                                    </div>
                                </div>
                                <button onClick={handleCreate} className="w-full bg-blue-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-200 mt-4">만들기</button>
                            </div>
                        </Modal>
                    </div>
                </div>
            );
        };

        // [Trip Detail Planner Component]
        const TripPlanner = ({ services, user, tripId, onBack }) => {
            const [dataLoading, setDataLoading] = useState(true);
            const [tripInfo, setTripInfo] = useState({ title: '', startDate: '', endDate: '' });
            const [items, setItems] = useState([]);
            const [settings, setSettings] = useState({ font: 'pretendard', theme: 'blue' });
            
            // UI States
            const [selectedDate, setSelectedDate] = useState('ALL'); 
            const [isItemModalOpen, setIsItemModalOpen] = useState(false);
            const [isTripModalOpen, setIsTripModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [itemToDelete, setItemToDelete] = useState(null);
            
            const [editingItem, setEditingItem] = useState(null);
            const [itemFormData, setItemFormData] = useState({ date: '', time: '', title: '', location: '', category: '활동', memo: '' });
            const [tripFormData, setTripFormData] = useState({});

            const currentTheme = themeConfig[settings.theme] || themeConfig.blue;
            
            // Font Options Updated
            const fontOptions = [
                { id: 'pretendard', name: '기본 (Pretendard)', class: 'font-pretendard' },
                { id: 'suit', name: 'SUIT', class: 'font-suit' },
                { id: 'nanum', name: '나눔스퀘어', class: 'font-nanum' },
                { id: 'seoul', name: '서울한강체', class: 'font-seoul' },
                { id: 'mysen', name: '어비 마이센', class: 'font-mysen' }
            ];

            useEffect(() => {
                const { db, appId } = services;
                const { collection, doc, onSnapshot } = window.Firebase;

                // Listen to Trip Info
                const tripRef = doc(db, 'artifacts', appId, 'users', user.uid, 'trips', tripId);
                const unsubTrip = onSnapshot(tripRef, (snap) => {
                    if(snap.exists()) {
                        const data = snap.data();
                        setTripInfo({ title: data.title, startDate: data.startDate, endDate: data.endDate });
                        setSettings({ font: data.font || 'pretendard', theme: data.theme || 'blue' });
                        setTripFormData({ title: data.title, startDate: data.startDate, endDate: data.endDate });
                    }
                });

                // Listen to Items (Subcollection)
                const itemsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'trips', tripId, 'items');
                const unsubItems = onSnapshot(itemsRef, (snap) => {
                    setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setDataLoading(false);
                });

                return () => { unsubTrip(); unsubItems(); };
            }, [tripId]);

            // Actions
            const updateTripSettings = async (updates) => {
                const { db, appId } = services; const { doc, setDoc } = window.Firebase;
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'trips', tripId), updates, { merge: true });
            };

            const handleTripUpdate = async () => {
                const { db, appId } = services; const { doc, setDoc } = window.Firebase;
                // Date Shift Check
                const oldStart = new Date(tripInfo.startDate);
                const newStart = new Date(tripFormData.startDate);
                const diffDays = Math.ceil((newStart - oldStart) / (1000 * 60 * 60 * 24));

                if (diffDays !== 0 && items.length > 0) {
                     if(confirm(`날짜가 변경되었네요. 일정들도 ${diffDays}일 이동할까요?`)) {
                         const batchPromises = items.map(item => {
                             const nd = new Date(item.date); nd.setDate(nd.getDate() + diffDays);
                             return setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'trips', tripId, 'items', item.id), { date: nd.toISOString().split('T')[0] }, { merge: true });
                         });
                         await Promise.all(batchPromises);
                     }
                }
                await updateTripSettings(tripFormData);
                setIsTripModalOpen(false);
            };

            const handleItemSubmit = async () => {
                if (!itemFormData.date || !itemFormData.title) return alert('정보를 입력해주세요.');
                const { db, appId } = services; const { doc, setDoc, collection } = window.Firebase;
                if (editingItem) {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'trips', tripId, 'items', editingItem.id), itemFormData, { merge: true });
                } else {
                    await setDoc(doc(collection(db, 'artifacts', appId, 'users', user.uid, 'trips', tripId, 'items')), itemFormData);
                }
                setIsItemModalOpen(false);
            };

            const confirmDelete = async () => {
                const { db, appId } = services; const { doc, deleteDoc } = window.Firebase;
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'trips', tripId, 'items', itemToDelete));
                setIsDeleteModalOpen(false);
            };

            // Helpers
            const getDaysArray = (s, e) => {
                const a = []; const d = new Date(s); const ed = new Date(e);
                if (isNaN(d) || isNaN(ed)) return [];
                while(d <= ed) { a.push(new Date(d).toISOString().split('T')[0]); d.setDate(d.getDate()+1); }
                return a;
            };
            const tripDays = useMemo(() => getDaysArray(tripInfo.startDate, tripInfo.endDate), [tripInfo]);
            const sortedItems = useMemo(() => items.filter(i => (selectedDate === 'ALL' || i.date === selectedDate) && tripDays.includes(i.date)).sort((a,b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time)), [items, selectedDate, tripDays]);

            if(dataLoading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-gray-400" /></div>;

            return (
                <div className={`min-h-screen pb-24 ${fontOptions.find(f => f.id === settings.font)?.class}`}>
                    <FontStyles />
                    <header className="sticky top-0 z-40 glass-effect border-b border-gray-100">
                        <div className="max-w-md mx-auto px-5 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <button onClick={onBack} className="p-2 -ml-2 hover:bg-gray-100 rounded-full text-gray-600"><ArrowLeft size={22}/></button>
                                <div onClick={() => { setTripFormData(tripInfo); setIsTripModalOpen(true); }} className="cursor-pointer group">
                                    <h1 className="text-xl font-extrabold text-gray-900 flex items-center gap-2">{tripInfo.title} <Edit2 size={16} className="text-gray-300 group-hover:text-gray-500"/></h1>
                                    <span className={`text-xs ${currentTheme.text} font-bold`}>{tripInfo.startDate} - {tripInfo.endDate}</span>
                                </div>
                            </div>
                            <div className="relative">
                                <button onClick={() => setIsSettingsOpen(!isSettingsOpen)} className="p-2 bg-white border border-gray-100 rounded-full text-gray-600"><Settings size={20}/></button>
                                {isSettingsOpen && (
                                    <>
                                    <div className="fixed inset-0 z-10" onClick={()=>setIsSettingsOpen(false)}/>
                                    <div className="absolute right-0 top-full mt-2 w-56 bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden z-20 p-3 animate-in fade-in slide-in-from-top-2">
                                        <p className="text-xs font-bold text-gray-400 mb-2">테마 컬러</p>
                                        <div className="flex gap-2 mb-4">{Object.entries(themeConfig).map(([k, c]) => <button key={k} onClick={() => updateTripSettings({theme: k})} className={`w-6 h-6 rounded-full ${c.primary} ${settings.theme === k ? 'ring-2 ring-gray-300' : ''}`}/>)}</div>
                                        <p className="text-xs font-bold text-gray-400 mb-2">폰트</p>
                                        <div className="space-y-1">{fontOptions.map(f => <button key={f.id} onClick={() => updateTripSettings({font: f.id})} className={`w-full text-left text-xs p-2 rounded ${settings.font === f.id ? 'bg-gray-100 font-bold' : ''}`}>{f.name}</button>)}</div>
                                    </div>
                                    </>
                                )}
                            </div>
                        </div>
                        <div className="max-w-md mx-auto px-5 pb-2 overflow-x-auto no-scrollbar flex space-x-2">
                            <button onClick={() => setSelectedDate('ALL')} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all ${selectedDate === 'ALL' ? `${currentTheme.primary} text-white shadow-md` : 'bg-white text-gray-500 border border-gray-100'}`}>전체</button>
                            {tripDays.map((d, i) => <button key={d} onClick={() => setSelectedDate(d)} className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all ${selectedDate === d ? `${currentTheme.primary} text-white shadow-md` : 'bg-white text-gray-500 border border-gray-100'}`}>Day {i+1}</button>)}
                        </div>
                    </header>
                    
                    <main className="max-w-md mx-auto px-5 py-6">
                        <div className="relative">
                            <div className="absolute left-4 top-4 bottom-4 w-0.5 bg-gray-200 rounded-full"></div>
                            <div className="space-y-8">
                                {sortedItems.map((item, idx) => (
                                    <div key={item.id}>
                                        {(idx === 0 || item.date !== sortedItems[idx-1].date) && selectedDate === 'ALL' && <div className="pl-12 mb-4"><span className={`inline-block px-3 py-1 rounded-lg ${currentTheme.light} ${currentTheme.text} text-xs font-extrabold`}>{tripDays.indexOf(item.date) > -1 ? `Day ${tripDays.indexOf(item.date)+1}` : ''} • {item.date}</span></div>}
                                        <div className="relative pl-12 group">
                                            <div className={`absolute left-[9px] top-6 w-3.5 h-3.5 bg-white border-4 ${currentTheme.border.replace('border', 'border')} rounded-full z-10`} style={{borderColor:'currentColor', color:'inherit'}}><div className={`w-full h-full rounded-full ${currentTheme.primary}`}/></div>
                                            <div className="bg-white p-5 rounded-3xl shadow-[0_2px_20px_rgba(0,0,0,0.04)] border border-gray-50">
                                                <div className="flex justify-between items-start mb-2">
                                                    <span className="inline-flex items-center px-2.5 py-1 rounded-lg bg-gray-100 text-xs font-bold text-gray-600"><Clock size={12} className="mr-1"/> {item.time}</span>
                                                    <div className="flex gap-2"><button onClick={() => { setEditingItem(item); setItemFormData(item); setIsItemModalOpen(true); }} className={`p-1.5 ${currentTheme.light} ${currentTheme.text} rounded-lg`}><Edit2 size={14}/></button><button onClick={() => { setItemToDelete(item.id); setIsDeleteModalOpen(true); }} className="p-1.5 bg-red-50 text-red-600 rounded-lg"><Trash2 size={14}/></button></div>
                                                </div>
                                                <h3 className="text-lg font-bold text-gray-900 mb-1">{item.title}</h3>
                                                <button onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank')} className={`flex items-center text-gray-500 text-sm hover:${currentTheme.text} text-left mb-2`}><MapPin size={14} className="mr-1"/> <span className="truncate">{item.location}</span></button>
                                                {item.memo && <div className="mt-3 pt-3 border-t border-dashed border-gray-100 text-xs text-gray-500 bg-gray-50/50 p-2 rounded-xl flex"><StickyNote size={12} className={`mr-1.5 mt-0.5 ${currentTheme.text}`}/> {item.memo}</div>}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {sortedItems.length === 0 && <div className="text-center py-20 text-gray-400"><p>일정이 없어요.</p><button onClick={() => { setEditingItem(null); setItemFormData({date: selectedDate==='ALL'?tripInfo.startDate:selectedDate, time:'', title:'', location:'', category:'활동', memo:''}); setIsItemModalOpen(true); }} className={`mt-4 ${currentTheme.text} font-bold`}>일정 추가하기</button></div>}
                            </div>
                        </div>
                    </main>

                    <div className="fixed bottom-6 right-6 z-30"><button onClick={() => { setEditingItem(null); setItemFormData({date: selectedDate==='ALL'?tripInfo.startDate:selectedDate, time:'', title:'', location:'', category:'활동', memo:''}); setIsItemModalOpen(true); }} className={`bg-gray-900 text-white p-4 rounded-full shadow-xl hover:scale-105 active:scale-95 flex items-center justify-center ml-auto ${currentTheme.shadow}`}><Plus size={28}/></button></div>

                    <Modal isOpen={isItemModalOpen} onClose={() => setIsItemModalOpen(false)} title={editingItem ? "일정 수정" : "새 일정"}>
                        <div className="space-y-1">
                            <div className="grid grid-cols-2 gap-3 mb-1">
                                <div className="mb-4"><label className="block text-sm font-medium text-gray-500 mb-1 ml-1">날짜</label><select value={itemFormData.date} onChange={e=>setItemFormData({...itemFormData, date:e.target.value})} className="w-full bg-gray-50 border border-gray-100 rounded-2xl px-4 py-3 text-gray-900">{tripDays.map((d,i)=><option key={d} value={d}>Day {i+1}</option>)}{!tripDays.includes(itemFormData.date) && <option value={itemFormData.date}>{itemFormData.date}</option>}</select></div>
                                <InputField label="시간" type="time" value={itemFormData.time} onChange={e=>setItemFormData({...itemFormData, time:e.target.value})} theme={settings.theme}/>
                            </div>
                            <InputField label="일정명" value={itemFormData.title} onChange={e=>setItemFormData({...itemFormData, title:e.target.value})} theme={settings.theme}/>
                            <InputField label="장소" value={itemFormData.location} onChange={e=>setItemFormData({...itemFormData, location:e.target.value})} theme={settings.theme}/>
                            <TextAreaField label="메모" value={itemFormData.memo} onChange={e=>setItemFormData({...itemFormData, memo:e.target.value})} theme={settings.theme}/>
                            <div className="pt-2"><button onClick={handleItemSubmit} className={`w-full ${currentTheme.primary} text-white font-bold py-4 rounded-2xl shadow-lg`}>{editingItem ? '수정' : '추가'}</button></div>
                        </div>
                    </Modal>

                    <Modal isOpen={isTripModalOpen} onClose={() => setIsTripModalOpen(false)} title="여행 정보 수정">
                        <div className="space-y-1">
                            <InputField label="제목" value={tripFormData.title} onChange={e=>setTripFormData({...tripFormData, title:e.target.value})} theme={settings.theme}/>
                            <div className="grid grid-cols-2 gap-3">
                                <InputField label="시작" type="date" value={tripFormData.startDate} onChange={e=>setTripFormData({...tripFormData, startDate:e.target.value})} theme={settings.theme}/>
                                <InputField label="종료" type="date" value={tripFormData.endDate} onChange={e=>setTripFormData({...tripFormData, endDate:e.target.value})} theme={settings.theme}/>
                            </div>
                            <div className="pt-4"><button onClick={handleTripUpdate} className="w-full bg-gray-900 text-white font-bold py-4 rounded-2xl">저장</button></div>
                        </div>
                    </Modal>

                    <Modal isOpen={isDeleteModalOpen} onClose={() => setIsDeleteModalOpen(false)} title="삭제"><div className="text-center py-4"><h3 className="font-bold text-lg mb-2">삭제할까요?</h3><div className="flex gap-2"><button onClick={()=>setIsDeleteModalOpen(false)} className="flex-1 bg-gray-100 py-3 rounded-xl">취소</button><button onClick={confirmDelete} className="flex-1 bg-red-500 text-white py-3 rounded-xl">삭제</button></div></div></Modal>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => (
             <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-50 font-pretendard text-center">
                <div className="mb-8 p-4 bg-white rounded-3xl shadow-lg shadow-blue-100 transform rotate-[-2deg]"><Plane size={48} className="text-blue-500" /></div>
                <h1 className="text-2xl font-bold text-gray-900 mb-2">여행 플래너</h1>
                <p className="text-gray-500 mb-8">여러 개의 여행을<br/>한 곳에서 관리하세요.</p>
                <button onClick={onLogin} className="flex items-center gap-3 bg-white border border-gray-200 px-6 py-4 rounded-2xl font-bold text-gray-700 shadow-sm hover:bg-gray-50 transition-all w-full max-w-xs justify-center">
                    Google 계정으로 시작하기
                </button>
            </div>
        );

        function App() {
            const { services, user, loading } = useFirebase();
            const [selectedTripId, setSelectedTripId] = useState(null);

            const handleLogin = async () => {
                const { signInWithPopup, GoogleAuthProvider } = window.Firebase;
                try { await signInWithPopup(services.auth, new GoogleAuthProvider()); } catch (e) { alert(e.message); }
            };

            const handleLogout = async () => {
                const { signOut } = window.Firebase;
                if(confirm("로그아웃 하시겠습니까?")) await signOut(services.auth);
            };

            if (loading) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-blue-500" /></div>;
            if (!user) return <LoginScreen onLogin={handleLogin} />;

            return (
                <>
                    {selectedTripId ? (
                        <TripPlanner 
                            services={services} 
                            user={user} 
                            tripId={selectedTripId} 
                            onBack={() => setSelectedTripId(null)} 
                        />
                    ) : (
                        <TripList 
                            services={services} 
                            user={user} 
                            onSelectTrip={setSelectedTripId}
                            onLogout={handleLogout}
                        />
                    )}
                </>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
